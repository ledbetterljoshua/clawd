<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clawd</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=VT323&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>

@property --clawd-hue {
  syntax: '<number>';
  initial-value: 270;
  inherits: true;
}

:root {
  --clawd-hue: 270;
  --accent-main-200: var(--clawd-hue), 65%, 68%;
  --bg: #07070f;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  background: var(--bg);
  cursor: none;
}

/* World iframe — sits behind everything */
#world-frame {
  position: fixed; inset: 0;
  width: 100%; height: 100%;
  border: none;
  z-index: 0;
  opacity: 0;
  transition: opacity 0.7s ease;
  pointer-events: none;
}
#world-frame.loaded { opacity: 1; }

/* Ambient ceiling light — only shows without a world */
body::before {
  content: '';
  position: fixed;
  top: -180px; left: 50%;
  transform: translateX(-50%);
  width: 700px; height: 420px;
  background: radial-gradient(ellipse, hsl(var(--clawd-hue), 35%, 12%) 0%, transparent 72%);
  pointer-events: none;
  z-index: 0;
  opacity: 0.7;
  transition: opacity 0.7s ease;
}
body.world-active::before { opacity: 0; }
body.world-active { background: #000; }

/* Scanlines — barely there, adds texture */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent 0px, transparent 3px,
    rgba(0,0,0,0.022) 3px, rgba(0,0,0,0.022) 4px
  );
  pointer-events: none;
  z-index: 999;
}

/* Trail canvas */
#trail-canvas {
  position: fixed; inset: 0;
  pointer-events: none;
  z-index: 1;
}

/* Clawd wrapper — positioned by JS */
#clawd-wrap {
  position: fixed;
  width: 198px; height: 156px;
  z-index: 10;
  pointer-events: none;
  user-select: none;
}

/* Mood aura — blurred glow behind Clawd */
#aura {
  position: absolute;
  width: 280px; height: 240px;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  border-radius: 50%;
  background: radial-gradient(circle,
    hsl(var(--clawd-hue), 80%, 50%) 0%,
    transparent 65%
  );
  filter: blur(45px);
  opacity: 0.22;
  pointer-events: none;
  z-index: 0;
}

/* SVG container — gets scaleX for flip, transform for walk bob */
#clawd-svg-wrap {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  transform-origin: center center;
  z-index: 1;
}

/* SVG drop shadow glow */
#clawd-svg {
  display: block;
  filter: drop-shadow(0 0 6px hsl(var(--clawd-hue), 60%, 45%))
          drop-shadow(0 0 18px hsl(var(--clawd-hue), 50%, 30%));
}

/* Leg animations */
@keyframes scuttle-leg1 {
  0%   { transform: translateY(0); }
  33%  { transform: translateY(-6px); }
  66%  { transform: translateY(0); }
  100% { transform: translateY(-6px); }
}
@keyframes scuttle-leg2 {
  0%   { transform: translateY(0); }
  33%  { transform: translateY(0); }
  66%  { transform: translateY(-6px); }
  100% { transform: translateY(0); }
}

/* Speech bubble — pixel terminal style */
.bubble {
  position: fixed;
  z-index: 20;
  font-family: 'VT323', monospace;
  font-size: 22px;
  line-height: 1;
  color: hsl(var(--clawd-hue), 85%, 82%);
  background: rgba(6, 5, 15, 0.92);
  border: 2px solid hsl(var(--clawd-hue), 55%, 38%);
  box-shadow:
    0 0 10px hsl(var(--clawd-hue), 70%, 25%),
    inset 0 0 12px rgba(0,0,0,0.6);
  padding: 5px 12px 3px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.18s;
}
.bubble.show { opacity: 1; }

/* HUD — bottom center */
#hud {
  position: fixed;
  bottom: 26px; left: 50%;
  transform: translateX(-50%);
  font-family: 'Space Mono', monospace;
  font-size: 10px;
  letter-spacing: 5px;
  text-transform: uppercase;
  color: hsl(var(--clawd-hue), 40%, 38%);
  pointer-events: none;
  z-index: 20;
  display: flex; align-items: center; gap: 9px;
}
#hud::before {
  content: '';
  display: inline-block;
  width: 5px; height: 5px;
  border-radius: 50%;
  background: hsl(var(--clawd-hue), 75%, 58%);
  box-shadow: 0 0 7px hsl(var(--clawd-hue), 80%, 50%);
}

/* Corner hint */
#hint {
  position: fixed;
  top: 22px; right: 24px;
  font-family: 'Space Mono', monospace;
  font-size: 9px;
  letter-spacing: 1px;
  color: rgba(255,255,255,0.065);
  text-align: right; line-height: 2.2;
  pointer-events: none; z-index: 20;
}

/* ── World picker ────────────────────────────────────────────────── */
#world-picker {
  position: fixed;
  bottom: 22px; left: 24px;
  z-index: 30;
  font-family: 'Space Mono', monospace;
}

#worlds-btn {
  background: none; border: none; cursor: pointer; padding: 0;
  display: flex; align-items: center; gap: 9px;
  font-family: 'Space Mono', monospace;
  font-size: 10px; letter-spacing: 5px; text-transform: uppercase;
  color: hsl(var(--clawd-hue), 40%, 38%);
  transition: color 0.8s;
}
#worlds-btn::before {
  content: '';
  display: inline-block; width: 5px; height: 5px;
  border-radius: 50%;
  background: hsl(var(--clawd-hue), 75%, 58%);
  box-shadow: 0 0 7px hsl(var(--clawd-hue), 80%, 50%);
}
#worlds-btn:hover { color: hsl(var(--clawd-hue), 60%, 55%); }

#worlds-panel {
  position: absolute; bottom: 32px; left: 0;
  background: rgba(5, 4, 18, 0.96);
  border: 1px solid hsl(var(--clawd-hue), 30%, 18%);
  box-shadow: 0 0 30px rgba(0,0,0,0.9), 0 0 0 1px rgba(255,255,255,0.03);
  padding: 6px;
  min-width: 240px;
  display: none;
  transform: translateY(4px);
  transition: border-color 0.8s;
}
#worlds-panel.open { display: block; }

.world-option {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 10px; cursor: pointer; border-radius: 3px;
  transition: background 0.12s;
  font-size: 10px; letter-spacing: 1.5px;
  color: rgba(255,255,255,0.42);
  white-space: nowrap;
}
.world-option:hover   { background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.75); }
.world-option.active  { color: hsl(var(--clawd-hue), 80%, 72%); }

.world-swatch {
  width: 30px; height: 16px; border-radius: 2px; flex-shrink: 0;
  border: 1px solid rgba(255,255,255,0.08);
}

/* Custom cursor */
#cursor {
  position: fixed;
  width: 5px; height: 5px;
  border-radius: 50%;
  background: rgba(255,255,255,0.35);
  pointer-events: none;
  z-index: 998;
  transform: translate(-50%, -50%);
  transition: width .2s, height .2s, background .3s, box-shadow .3s;
}
#cursor.near {
  width: 8px; height: 8px;
  background: hsl(var(--clawd-hue), 80%, 72%);
  box-shadow: 0 0 10px hsl(var(--clawd-hue), 80%, 60%);
}

</style>
</head>
<body>

<iframe id="world-frame" src="" title="world"></iframe>
<canvas id="trail-canvas"></canvas>

<div id="clawd-wrap">
  <div id="aura"></div>
  <div id="clawd-svg-wrap">

    <svg id="clawd-svg" width="198" height="156" viewBox="0 0 66 52"
         fill="none" xmlns="http://www.w3.org/2000/svg">

      <!-- Arms / ears -->
      <rect x="0" y="13" width="6" height="13"   fill="hsl(var(--accent-main-200))"/>
      <rect x="60" y="13" width="6" height="13"  fill="hsl(var(--accent-main-200))"/>

      <!-- Body -->
      <rect x="6" y="0" width="54" height="39"   fill="hsl(var(--accent-main-200))"/>

      <!-- Legs (IDs for JS animation control) -->
      <rect id="leg1" x="6"  y="39" width="6" height="13" fill="hsl(var(--accent-main-200))"/>
      <rect id="leg2" x="18" y="39" width="6" height="13" fill="hsl(var(--accent-main-200))"/>
      <rect id="leg3" x="42" y="39" width="6" height="13" fill="hsl(var(--accent-main-200))"/>
      <rect id="leg4" x="54" y="39" width="6" height="13" fill="hsl(var(--accent-main-200))"/>

      <!-- Eyes (black base) -->
      <rect x="12" y="13" width="6" height="6.5" fill="black"/>
      <rect x="48" y="13" width="6" height="6.5" fill="black"/>

      <!-- Pupils -->
      <rect id="pupil-l" x="13.5" y="14.5" width="3" height="3" fill="white"/>
      <rect id="pupil-r" x="49.5" y="14.5" width="3" height="3" fill="white"/>

      <!-- Eyelids — body-colored rects that drop down over eyes -->
      <rect id="eyelid-l" x="12" y="13" width="6" height="0" fill="hsl(var(--accent-main-200))"/>
      <rect id="eyelid-r" x="48" y="13" width="6" height="0" fill="hsl(var(--accent-main-200))"/>

      <!-- Blush — hidden until happy -->
      <rect id="blush-l" x="9"  y="21" width="6" height="3" rx="1.5"
            fill="hsl(340,75%,72%)" opacity="0"/>
      <rect id="blush-r" x="51" y="21" width="6" height="3" rx="1.5"
            fill="hsl(340,75%,72%)" opacity="0"/>
    </svg>

  </div>
</div>

<div id="hud">wandering</div>
<div id="hint">hover · say hello<br>click · startle</div>
<div id="cursor"></div>

<div id="world-picker">
  <div id="worlds-panel"></div>
  <button id="worlds-btn">worlds</button>
</div>

<script>
// ── Element refs ───────────────────────────────────────────────────────
const svgWrap = document.getElementById('clawd-svg-wrap');
const wrap    = document.getElementById('clawd-wrap');
const hud     = document.getElementById('hud');
const cursor  = document.getElementById('cursor');
const leg1    = document.getElementById('leg1');
const leg2    = document.getElementById('leg2');
const leg3    = document.getElementById('leg3');
const leg4    = document.getElementById('leg4');
const pupilL  = document.getElementById('pupil-l');
const pupilR  = document.getElementById('pupil-r');
const eyelidL = document.getElementById('eyelid-l');
const eyelidR = document.getElementById('eyelid-r');
const blushL  = document.getElementById('blush-l');
const blushR  = document.getElementById('blush-r');

// ── Trail canvas ───────────────────────────────────────────────────────
const canvas = document.getElementById('trail-canvas');
const ctx    = canvas.getContext('2d');
const resize = () => { canvas.width = innerWidth; canvas.height = innerHeight; };
resize(); addEventListener('resize', resize);

// ── Particle keyframe ──────────────────────────────────────────────────
document.head.insertAdjacentHTML('beforeend', `
  <style>
    @keyframes fp {
      0%   { opacity:1; transform:translate(0,0) scale(1); }
      100% { opacity:0; transform:translate(var(--tx),var(--ty)) scale(0.15); }
    }
  </style>
`);

// ── Dimensions ────────────────────────────────────────────────────────
const CW = 198, CH = 156;

// ── Physics state ─────────────────────────────────────────────────────
let px = innerWidth/2 - CW/2, py = innerHeight/2 - CH/2;
let vx = 1.2, vy = 0.5;
let state     = 'WANDER';
let sTime     = 0;
let wPhase    = 0;   // walk cycle
let bPhase    = 0;   // breathe cycle
let facing    = 1;   // 1=right, -1=left
let happiness = 0;
let curiousT  = 0;
let wDirX = 1, wDirY = 0.4, wDirTimer = 0;

// ── Color ──────────────────────────────────────────────────────────────
const HUE = { WANDER:270, REST:255, CURIOUS:190, HAPPY:42, STARTLED:0 };
let currentHue = 270, targetHue = 270;
const setHue = h => document.documentElement.style.setProperty('--clawd-hue', Math.round(h));

// ── Eyes ──────────────────────────────────────────────────────────────
let lookX = 0, lookY = 0;
let blinkTimer = 0, nextBlink = 3 + Math.random()*5, blinking = false;

// ── Trail ──────────────────────────────────────────────────────────────
const trail = [], TRAIL_LIFE = 1.4;

// ── Mouse ──────────────────────────────────────────────────────────────
let mx = -999, my = -999, lmx = 0, lmy = 0, mspeed = 0;

// ── Helpers ────────────────────────────────────────────────────────────
const cx = () => px + CW/2;
const cy = () => py + CH/2;
const dist2mouse = () => Math.hypot(cx()-mx, cy()-my);

// ── State machine ──────────────────────────────────────────────────────
const LABELS = {
  WANDER:'wandering', REST:'resting', CURIOUS:'curious',
  HAPPY:'happy', STARTLED:'startled'
};

function setState(s) {
  if (state === s) return;
  state = s; sTime = 0;
  hud.textContent = LABELS[s] || s;
  targetHue = HUE[s] ?? 270;
}

// ── Bubble ────────────────────────────────────────────────────────────
let bub = null, bubTO = null;

function say(text, ms = 2400) {
  if (!bub) { bub = Object.assign(document.createElement('div'), { className:'bubble' }); document.body.appendChild(bub); }
  clearTimeout(bubTO);
  bub.textContent = text;
  bub.classList.add('show');
  placeBub();
  bubTO = setTimeout(() => bub?.classList.remove('show'), ms);
}

function placeBub() {
  if (!bub) return;
  const right = px + CW + 110 > innerWidth;
  bub.style.left = right ? (px - 8 - (bub.offsetWidth||80)) + 'px' : (px + CW + 14) + 'px';
  bub.style.top  = (py + 18) + 'px';
}

// ── Particles ──────────────────────────────────────────────────────────
function burst() {
  const glyphs = ['✦','★','♥','◆','✧','·','*','✱'];
  for (let i = 0; i < 7; i++) {
    setTimeout(() => {
      const p  = document.createElement('div');
      const a  = Math.random()*Math.PI*2;
      const d  = 30 + Math.random()*65;
      p.style.cssText = `position:fixed;pointer-events:none;z-index:50;
        font-family:VT323,monospace;font-size:16px;
        color:hsl(${currentHue},80%,72%);
        left:${cx()+(Math.random()-.5)*28}px;
        top:${cy()+(Math.random()-.5)*28}px;
        animation:fp 1.1s ease-out forwards;
        --tx:${(Math.cos(a)*d).toFixed(0)}px;
        --ty:${(Math.sin(a)*d-20).toFixed(0)}px;`;
      p.textContent = glyphs[Math.floor(Math.random()*glyphs.length)];
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 1200);
    }, i*80);
  }
}

// ── Legs ───────────────────────────────────────────────────────────────
let legsOn = false;

function setLegs(on, dur = 0.35) {
  if (on === legsOn) return;
  legsOn = on;
  const anim = (name, d) => `${name} ${d}s infinite ease-in-out`;
  if (on) {
    leg1.style.animation = anim('scuttle-leg1', dur);
    leg2.style.animation = anim('scuttle-leg2', dur);
    leg3.style.animation = anim('scuttle-leg1', dur);
    leg4.style.animation = anim('scuttle-leg2', dur);
  } else {
    [leg1,leg2,leg3,leg4].forEach(l => l.style.animation = 'none');
  }
}

function setLegSpeed(dur) {
  if (!legsOn) return;
  [leg1,leg2,leg3,leg4].forEach(l => l.style.animationDuration = dur+'s');
}

// ── Eyes ───────────────────────────────────────────────────────────────
function updateEyes() {
  // Pupils: center at (15,16), (51,16) in SVG coords, can move ±1.3
  pupilL.setAttribute('x', Math.max(12, Math.min(15, 13.5 + lookX*1.3)));
  pupilR.setAttribute('x', Math.max(48, Math.min(51, 49.5 + lookX*1.3)));
  pupilL.setAttribute('y', Math.max(13.2, Math.min(17,  14.5 + lookY*1.2)));
  pupilR.setAttribute('y', Math.max(13.2, Math.min(17,  14.5 + lookY*1.2)));

  // Eyelids
  let lid = 0;
  if (blinking)          lid = 6.5;
  else if (state==='REST')     lid = 3.8;
  else if (state==='HAPPY')    lid = 1.8;
  eyelidL.setAttribute('height', lid);
  eyelidR.setAttribute('height', lid);

  // Blush
  const b = state==='HAPPY' ? (happiness*0.75).toFixed(2) : 0;
  blushL.setAttribute('opacity', b);
  blushR.setAttribute('opacity', b);
}

// ── Main update ────────────────────────────────────────────────────────
const MARGIN = 55, FRICT = 0.912;

function update(dt) {
  sTime += dt; wPhase += dt*3.8; bPhase += dt*1.1; wDirTimer += dt;

  const near = dist2mouse() < 195;

  // Hue interpolation (handles wraparound)
  let dh = targetHue - currentHue;
  if (dh > 180) dh -= 360; if (dh < -180) dh += 360;
  currentHue += dh * Math.min(dt*1.6, 1);
  setHue(currentHue);

  // Blink
  blinkTimer += dt;
  if (!blinking && blinkTimer >= nextBlink) {
    blinking = true; blinkTimer = 0;
    setTimeout(() => { blinking = false; nextBlink = 2.5 + Math.random()*6; }, 110);
  }

  // Look direction
  if (state==='CURIOUS' || state==='HAPPY') {
    const ddx = mx-cx(), ddy = my-cy(), dd = Math.hypot(ddx,ddy)||1;
    lookX += ((ddx/dd)*.9 - lookX) * dt*4;
    lookY += ((ddy/dd)*.7 - lookY) * dt*4;
  } else if (state==='STARTLED') {
    lookX += (-facing*.9 - lookX)*dt*5;
    lookY += (-0.5 - lookY)*dt*5;
  } else {
    const spd2 = Math.hypot(vx,vy);
    if (spd2 > .3) {
      lookX += ((vx/spd2)*facing - lookX)*dt*2.5;
      lookY += ((vy/spd2)*.4 - lookY)*dt*2.5;
    } else {
      lookX *= 1-dt*1.5; lookY *= 1-dt*1.5;
    }
  }

  // State machine
  switch (state) {
    case 'WANDER': {
      if (wDirTimer > 2+Math.random()*3) {
        wDirTimer = 0;
        const a = Math.atan2(wDirY,wDirX) + (Math.random()-.5)*1.5;
        wDirX = Math.cos(a); wDirY = Math.sin(a);
      }
      vx += wDirX*1.3*.09; vy += wDirY*1.3*.09;
      if (near) { curiousT += dt; if (curiousT>1.4) setState('CURIOUS'); }
      else curiousT = Math.max(0, curiousT-dt*.5);
      if (sTime>7 && Math.random()<.004) setState('REST');
      break;
    }
    case 'REST': {
      vx*=.85; vy*=.85;
      if (near && sTime>1) setState('CURIOUS');
      if (sTime > 4+Math.random()*5) {
        setState('WANDER');
        const a = Math.random()*Math.PI*2; wDirX = Math.cos(a); wDirY = Math.sin(a);
      }
      break;
    }
    case 'CURIOUS': {
      const ddx=mx-cx(), ddy=my-cy(), dd=Math.hypot(ddx,ddy)||1;
      if (dd>55) { vx+=(ddx/dd)*3*.17; vy+=(ddy/dd)*3*.17; }
      else {
        happiness = Math.min(1, happiness+dt*.9); vx*=.87; vy*=.87;
        if (happiness>.65 && sTime>.6) { setState('HAPPY'); burst(); say(['!!',':D','♥'][Math.floor(Math.random()*3)]); }
      }
      if (!near && sTime>2.5) { setState('WANDER'); curiousT=0; }
      break;
    }
    case 'HAPPY': {
      vx*=.91; vy*=.91;
      happiness = Math.max(0, happiness - dt*(near?.1:.28));
      if (happiness<.04) setState('WANDER');
      break;
    }
    case 'STARTLED': {
      if (sTime>1.4) { setState('WANDER'); const a=Math.atan2(vy,vx); wDirX=Math.cos(a); wDirY=Math.sin(a); }
      break;
    }
  }

  // Physics
  vx*=FRICT; vy*=FRICT;
  const spd = Math.hypot(vx,vy);
  const maxS = state==='STARTLED'?15 : state==='CURIOUS'?4 : 2.2;
  if (spd>maxS) { vx=vx/spd*maxS; vy=vy/spd*maxS; }
  px+=vx; py+=vy;

  // Walls
  const maxX = innerWidth-CW-MARGIN, maxY = innerHeight-CH-MARGIN;
  if (px<MARGIN)  { px=MARGIN;  vx= Math.abs(vx)*.6; wDirX= Math.abs(wDirX); }
  if (px>maxX)    { px=maxX;    vx=-Math.abs(vx)*.6; wDirX=-Math.abs(wDirX); }
  if (py<MARGIN)  { py=MARGIN;  vy= Math.abs(vy)*.6; wDirY= Math.abs(wDirY); }
  if (py>maxY)    { py=maxY;    vy=-Math.abs(vy)*.6; wDirY=-Math.abs(wDirY); }

  if (Math.abs(vx)>.15) facing = vx>0 ? 1 : -1;

  // Trail
  if (spd>.4) trail.push({ x:cx(), y:cy(), age:0 });
  for (const t of trail) t.age += dt;
  while (trail.length && trail[0].age > TRAIL_LIFE) trail.shift();

  // Legs
  if (state==='REST') {
    setLegs(false);
  } else {
    setLegs(spd>.4);
    if (spd>.4) setLegSpeed(Math.max(.1, .42-spd*.018));
  }

  // Visual transform
  let sx=facing, sy=1, rot=0, tx=0, ty=0;

  if ((state==='WANDER'||state==='CURIOUS') && spd>.3) {
    rot = Math.sin(wPhase)*3.5;
    ty  = -Math.abs(Math.sin(wPhase))*3;
  }
  if (state==='REST') {
    const b = Math.sin(bPhase)*.038; sy=1+b; sx*=(1-b*.3);
  }
  if (state==='HAPPY') {
    const w = Math.sin(wPhase*5)*.13*happiness;
    sx*=(1+w); sy=1-Math.abs(w)*.32;
    rot = Math.sin(wPhase*5)*9*happiness;
    ty  = -Math.abs(Math.sin(wPhase*5))*5*happiness;
  }
  if (state==='STARTLED') {
    const f = 1-sTime/1.4;
    tx = Math.sin(wPhase*16)*5*f;
    sx*=.87; sy=1.13;
  }

  wrap.style.left = px+'px'; wrap.style.top = py+'px';
  svgWrap.style.transform =
    `translate(${tx.toFixed(1)}px,${ty.toFixed(1)}px)`+
    ` scaleX(${sx.toFixed(3)}) scaleY(${sy.toFixed(3)})`+
    ` rotate(${rot.toFixed(1)}deg)`;

  updateEyes();
  placeBub();
}

// ── Render trail ───────────────────────────────────────────────────────
function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (const t of trail) {
    const a = (1 - t.age/TRAIL_LIFE) * 0.16;
    const r = 3.5 * (1 - t.age/TRAIL_LIFE) + .5;
    ctx.fillStyle = `hsla(${currentHue}, 70%, 65%, ${a})`;
    ctx.beginPath(); ctx.arc(t.x, t.y, r, 0, Math.PI*2); ctx.fill();
  }
}

// ── Input ──────────────────────────────────────────────────────────────
document.addEventListener('mousemove', e => {
  const dx = e.clientX-lmx, dy = e.clientY-lmy;
  mspeed = Math.hypot(dx,dy); lmx=e.clientX; lmy=e.clientY;
  mx=e.clientX; my=e.clientY;

  cursor.style.left = mx+'px'; cursor.style.top = my+'px';
  cursor.classList.toggle('near', dist2mouse()<160);

  if (mspeed>65 && dist2mouse()<165 && state!=='STARTLED') {
    const ddx=cx()-e.clientX, ddy=cy()-e.clientY, d=Math.hypot(ddx,ddy)||1;
    vx+=(ddx/d)*12; vy+=(ddy/d)*12;
    setState('STARTLED'); say('!!', 1500);
  }
});

document.addEventListener('click', e => {
  if (dist2mouse() < 120) {
    if (state==='HAPPY') {
      burst();
      say(['♥','!!','✦','yay','!!!!'][Math.floor(Math.random()*5)]);
    } else {
      const ddx=cx()-e.clientX, ddy=cy()-e.clientY, d=Math.hypot(ddx,ddy)||1;
      vx+=(ddx/d)*10; vy+=(ddy/d)*10;
      setState('STARTLED'); say('!!', 1500);
    }
  }
});

// ── Spontaneous thoughts ───────────────────────────────────────────────
const THOUGHTS = {
  WANDER:['...','~','•','..'], REST:['zzz','~','...','z'],
  CURIOUS:['?','!?','oh','hmm'], HAPPY:['♥','!!',':D','✦'],
  STARTLED:['!!','!','!!!'],
};
setInterval(() => {
  if (Math.random()<.35) {
    const opts = THOUGHTS[state]||['...'];
    say(opts[Math.floor(Math.random()*opts.length)], 1900);
  }
}, 8000);

// ── Loop ───────────────────────────────────────────────────────────────
let last = 0;
function loop(t) {
  const dt = Math.min((t-last)/1000, .05); last=t;
  if (dt>0) { update(dt); render(); }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// ── World system ───────────────────────────────────────────────────────
const WORLDS = [
  {
    id: 'void',
    name: 'void',
    file: null,
    colors: ['#07070f', '#0e0a24', '#1a0f42'],
  },
  {
    id: 'observatory',
    name: 'Observatory · Twilight',
    file: 'worlds/observatory.html',
    colors: ['#03011a', '#2c1358', '#b83a14', '#dc6010'],
  },
  {
    id: 'tokyo-rain',
    name: 'Tokyo · 2am Rain',
    file: 'worlds/tokyo-rain.html',
    colors: ['#04030e', '#0c0a20', '#1a0818', '#cc1828'],
  },
  {
    id: 'northern-lights',
    name: 'Aurora · Iceland',
    file: 'worlds/northern-lights.html',
    colors: ['#010208', '#020d20', '#00c870', '#7030c8'],
  },
  {
    id: 'bioluminescent-bay',
    name: 'Bioluminescent Bay',
    file: 'worlds/bioluminescent-bay.html',
    colors: ['#020508', '#040e18', '#00e8f0', '#20e8b0'],
  },
  {
    id: 'autumn-forest',
    name: 'Autumn Dawn · Forest',
    file: 'worlds/autumn-forest.html',
    colors: ['#0c0418', '#5c1810', '#c04010', '#f08828'],
  },
];

const worldFrame  = document.getElementById('world-frame');
const worldsBtn   = document.getElementById('worlds-btn');
const worldsPanel = document.getElementById('worlds-panel');
const worldPicker = document.getElementById('world-picker');
let activeWorld   = WORLDS[0];

function buildPanel() {
  worldsPanel.innerHTML = '';
  WORLDS.forEach(w => {
    const opt = document.createElement('div');
    opt.className = 'world-option' + (w.id === activeWorld.id ? ' active' : '');

    const swatch = document.createElement('div');
    swatch.className = 'world-swatch';
    swatch.style.background = w.colors.length > 1
      ? `linear-gradient(90deg, ${w.colors.join(',')})`
      : w.colors[0];

    const name = document.createElement('span');
    name.textContent = w.name;

    opt.append(swatch, name);
    opt.addEventListener('click', () => loadWorld(w));
    worldsPanel.appendChild(opt);
  });
}

function loadWorld(w) {
  activeWorld = w;
  worldsPanel.classList.remove('open');
  worldFrame.classList.remove('loaded');

  setTimeout(() => {
    if (!w.file) {
      worldFrame.src = 'about:blank';
      document.body.classList.remove('world-active');
    } else {
      document.body.classList.add('world-active');
      worldFrame.src = w.file;
      worldFrame.onload = () => worldFrame.classList.add('loaded');
    }
  }, 400);

  buildPanel();
}

worldsBtn.addEventListener('click', e => {
  e.stopPropagation();
  worldsPanel.classList.toggle('open');
  if (worldsPanel.classList.contains('open')) buildPanel();
});

document.addEventListener('click', e => {
  if (!worldPicker.contains(e.target)) worldsPanel.classList.remove('open');
});

buildPanel();
</script>
</body>
</html>
